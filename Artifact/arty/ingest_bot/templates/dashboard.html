<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ingest Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body { padding: 1rem; }
      #plots img { max-width: 100%; height: auto; }
      .card { margin-bottom: 1rem; }
      #surface { width: 100%; height: 600px; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row mb-3">
        <div class="col-md-6">
          <h1>Ingest Bot Dashboard</h1>
        </div>
        <div class="col-md-6 text-end">
          <div class="input-group">
            <select id="reports" class="form-select"></select>
            <button id="load" class="btn btn-primary me-2">Load Report</button>
            <select id="ingests" class="form-select ms-2"></select>
            <button id="loadIngest" class="btn btn-outline-secondary ms-2">Load Ingest</button>
            <button id="viewIngest" class="btn btn-outline-info ms-2">View Records</button>
            <button id="runIngest" class="btn btn-success ms-2">Run Now</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <div id="price_card" class="card">
            <div class="card-body">
              <h5 class="card-title">Price & Indicators</h5>
              <div id="price_chart"></div>
            </div>
          </div>

          <div id="equity_card" class="card">
            <div class="card-body">
              <h5 class="card-title">Equity Curve</h5>
              <div id="equity_chart"></div>
            </div>
          </div>

          <div id="surface_card" class="card">
            <div class="card-body">
              <h5 class="card-title">Parameter Surface</h5>
              <div class="row mb-2">
                <div class="col"><input id="xvals" class="form-control" value="1,2,3,4,5" /></div>
                <div class="col"><input id="yvals" class="form-control" value="10,20,30" /></div>
                <div class="col"><button id="computeSurface" class="btn btn-secondary">Compute Surface</button></div>
              </div>
              <div id="surface"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Summary</h5>
              <pre id="summary" style="white-space: pre-wrap;"></pre>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Return Distribution</h5>
              <div id="hist"></div>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Jobs</h5>
              <div class="mb-2"><button id="startSurfaceJob" class="btn btn-sm btn-outline-primary">Start Surface Job (background)</button></div>
              <div id="jobStatus"></div>
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Ingest Records</h5>
              <pre id="ingestRecords" style="white-space: pre-wrap; max-height: 300px; overflow: auto;"></pre>
              <div class="mt-2"><small id="ingestRunStatus"></small></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function loadReports(){
        const res = await fetch('/api/reports');
        const arr = await res.json();
        const sel = document.getElementById('reports');
        sel.innerHTML = '';
        arr.forEach(r => {
          const o = document.createElement('option'); o.value=r; o.text=r; sel.appendChild(o);
        });
      }

      async function loadIngests(){
        const res = await fetch('/api/ingests');
        const arr = await res.json();
        const sel = document.getElementById('ingests');
        sel.innerHTML = '';
        arr.forEach(r => {
          const o = document.createElement('option'); o.value=r; o.text=r; sel.appendChild(o);
        });
      }

      async function loadReport(){
        const name = document.getElementById('reports').value;
        if(!name) return;
        const res = await fetch('/api/report/' + encodeURIComponent(name));
        const data = await res.json();
        document.getElementById('summary').innerText = JSON.stringify(data.summary, null, 2);

        // fetch timeseries JSON for plotting
        const tsres = await fetch('/api/report/' + encodeURIComponent(name) + '/timeseries');
        const ts = await tsres.json();
        const time = ts.series.timestamps;
        const close = ts.series.close;
        const traces = [{ x: time, y: close, type: 'scatter', name: 'close' }];
        // add SMAs if present
        for (const k in ts.sma){
          traces.push({ x: time, y: ts.sma[k], type: 'scatter', name: k });
        }
        Plotly.newPlot('price_chart', traces, {title: name + ' price & indicators'});

        // equity and drawdown data from report.json if present
        // load equity png as fallback
        try{
          const eqRes = await fetch('/reports/' + name + '/' + name + '_equity.png');
          if(eqRes.ok){
            document.getElementById('equity_chart').innerHTML = `<img src='/reports/${name}/${name}_equity.png' style='max-width:100%'>`;
          }
        }catch(e){ console.warn(e) }

        // build histogram for returns
        const returns = [];
        for(let i=1;i<close.length;i++) returns.push((close[i]-close[i-1])/close[i-1]);
        Plotly.newPlot('hist', [{ x: returns, type: 'histogram' }], {title: 'Return Distribution'});
        document.getElementById('surface').innerHTML = '';
        document.getElementById('jobStatus').innerText = '';
      }

      async function viewIngest(){
        const name = document.getElementById('ingests').value;
        if(!name) return;
        const res = await fetch('/api/ingest/' + encodeURIComponent(name) + '/records');
        if(res.status!==200){
          document.getElementById('ingestRecords').innerText = 'Records not found';
          return;
        }
        const data = await res.json();
        document.getElementById('ingestRecords').innerText = JSON.stringify(data.slice(0,200), null, 2);
      }

      async function runIngestNow(){
        const name = document.getElementById('ingests').value;
        if(!name) return;
        document.getElementById('ingestRunStatus').innerText = 'Starting...';
        const res = await fetch('/api/ingest/' + encodeURIComponent(name) + '/run', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
        const r = await res.json();
        if(res.status===202){
          document.getElementById('ingestRunStatus').innerText = 'Started (pid: ' + r.pid + ')';
        }else{
          document.getElementById('ingestRunStatus').innerText = 'Error: ' + (r.error||JSON.stringify(r));
        }
      }

      async function computeSurface(){
        const name = document.getElementById('reports').value;
        if(!name) return;
        const xvals = document.getElementById('xvals').value;
        const yvals = document.getElementById('yvals').value;
        const res = await fetch(`/api/report/${encodeURIComponent(name)}/surface?xvals=${encodeURIComponent(xvals)}&yvals=${encodeURIComponent(yvals)}`);
        if(res.status==202){
          alert('Surface not computed yet. Start background job.');
          return;
        }
        const grid = await res.json();
        const X = grid.x;
        const Y = grid.y;
        const Z = grid.z;
        Plotly.newPlot('surface', [{type:'surface', z: Z, x: X, y: Y}], {title: 'Parameter surface'});
      }

      document.getElementById('load').addEventListener('click', loadReport);
      document.getElementById('computeSurface').addEventListener('click', computeSurface);
      document.getElementById('loadIngest').addEventListener('click', viewIngest);
      document.getElementById('viewIngest').addEventListener('click', viewIngest);
      document.getElementById('runIngest').addEventListener('click', runIngestNow);

      // start background job button
      document.getElementById('startSurfaceJob').addEventListener('click', async ()=>{
        const name = document.getElementById('reports').value;
        const xvals = document.getElementById('xvals').value;
        const yvals = document.getElementById('yvals').value;
        const res = await fetch(`/api/report/${encodeURIComponent(name)}/surface/compute`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({xvals, yvals, train_window:30})});
        const r = await res.json();
        if(r.job_id){
          document.getElementById('jobStatus').innerText = 'Job started: ' + r.job_id;
          // poll status
          const jid = r.job_id;
          const interval = setInterval(async ()=>{
            const s = await fetch(`/api/report/${encodeURIComponent(name)}/surface/status/${jid}`);
            const js = await s.json();
            document.getElementById('jobStatus').innerText = 'Job: ' + js.status + (js.error?(' error:'+js.error):'');
            if(js.status=='finished' || js.status=='error'){
              clearInterval(interval);
              if(js.status=='finished') loadReport();
            }
          }, 2000);
        }
      });

      loadReports(); loadIngests();
    </script>
  </body>
</html>