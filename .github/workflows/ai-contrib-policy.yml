name: Enforce AI Contribution Policy

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  enforce-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Optional bypass (admin-controlled)
        if: ${{ vars.AI_POLICY_BYPASS == 'true' || secrets.AI_POLICY_BYPASS == 'true' }}
        run: |
          echo "AI policy checks bypassed (AI_POLICY_BYPASS=true)."
          exit 0

      - name: Ensure `jq` is available
        run: |
          echo "Checking for jq..."
          if ! command -v jq >/dev/null; then
            echo "jq not found, installing..."
            sudo apt-get update -qq && sudo apt-get install -y -qq jq
          fi
          jq --version || true

      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Verify PR actor is authorized AI
        env:
          PR_AUTHOR: ${{ github.actor }}
        run: |
          echo "github.actor: ${{ github.actor }}"
          echo "pr user login: ${{ github.event.pull_request.user.login }}"
          echo "event sender login: ${{ github.event.sender.login }}"
          # Fetch base ref copy of AI_AUTHORIZED.json if available and prefer it for authoritative list
          BASE_REF="${{ github.base_ref }}"
          echo "Base ref: $BASE_REF"
          git fetch origin $BASE_REF --depth=1 || true
          AUTH_JSON=''
          if git show origin/$BASE_REF:AI_AUTHORIZED.json >/dev/null 2>&1; then
            echo "Using AI_AUTHORIZED.json from base branch origin/$BASE_REF"
            AUTH_JSON=$(git show origin/$BASE_REF:AI_AUTHORIZED.json)
          elif [ -f AI_AUTHORIZED.json ]; then
            echo "Using AI_AUTHORIZED.json from the checked-out head"
            AUTH_JSON=$(cat AI_AUTHORIZED.json)
          else
            echo "AI_AUTHORIZED.json not found in base or head"; exit 1
          fi

          # Build normalized authorized list from chosen JSON
          AUTHORIZED_NORMALIZED=$(echo "$AUTH_JSON" | jq -r '.actors[]' 2>/dev/null | while read -r a; do echo "$a" | tr '[:upper:]' '[:lower:]' | sed 's/\[bot\]$//' | sed 's/[-_]/ /g' | xargs; done)
          echo "Authorized actors (normalized):"
          echo "$AUTHORIZED_NORMALIZED"

          # Compose candidate actor values to check
          CANDIDATES="${{ github.actor }} ${{ github.event.pull_request.user.login }} ${{ github.event.sender.login }}"
          # Also include the raw PR_AUTHOR env in case it's set differently
          CANDIDATES="$CANDIDATES $PR_AUTHOR"
          echo "Actor candidates:"
          echo "$CANDIDATES"

          matched=0
          for c in $CANDIDATES; do
            if [ -z "$c" ]; then continue; fi
            PR_NORMALIZED=$(echo "$c" | tr '[:upper:]' '[:lower:]' | sed 's/\[bot\]$//' | sed 's/[-_]/ /g' | xargs)
            echo "Checking candidate '$c' -> normalized '$PR_NORMALIZED'"
            if echo "$AUTHORIZED_NORMALIZED" | grep -Fx "$PR_NORMALIZED" >/dev/null; then
              echo "Match found: '$c' (normalized: '$PR_NORMALIZED')"
              matched=1
              break
            fi
          done

          if [ "$matched" -ne 1 ]; then
            echo "No authorized actor matched. Rejecting PR."; exit 1
          fi
          echo "Author authorized." 

      - name: Ensure attestation is present in PR
        run: |
          BASE_REF="${{ github.base_ref }}"
          echo "Checking for attestation files against base $BASE_REF"
          git fetch origin $BASE_REF --depth=1
          CHANGED=$(git diff --name-only origin/$BASE_REF...HEAD)
          echo "Changed files:\n$CHANGED"
          # Accept files that include AI_ATTESTATION anywhere in the path/name
          if ! echo "$CHANGED" | grep -E 'AI_ATTESTATION' >/dev/null; then
            echo "No AI attestation file detected in PR. Add an 'AI_ATTESTATION*.json' file to the PR."; exit 1
          fi
          echo "Attestation present." 

      - name: Validate attestation schema (basic)
        run: |
          # Validate that the attestation JSON includes required keys
          ATT_FILE=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E 'AI_ATTESTATION.*\.json$' | head -n1)
          if [ -z "$ATT_FILE" ]; then echo "No attestation file found for validation (skipping)."; exit 0; fi
          echo "Validating $ATT_FILE"
          if ! jq -e '.ai_name and .ai_version and .model_hash and .commit_hash and .timestamp and .signature' "$ATT_FILE" >/dev/null; then
            echo "Attestation $ATT_FILE is missing required fields."; exit 1
          fi
          echo "Attestation schema OK"
